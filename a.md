# ゲームシーンにおけるマップ・エンティティの描画

## 定数の定義

- **TILE_SIZE**  
  タイルの大きさ（ピクセル単位）の整数値。

- **SCREEN_SIZE**  
  スクリーンの大きさを表す {SCREEN_WIDTH, SCREEN_HEIGHT}。  
  例: SCREEN_SIZE = {800, 600}

- **MAP_SIZE**  
  マップの大きさ（タイル単位）の (MAP_WIDTH, MAP_HEIGHT)  
  例: MAP_SIZE = (100, 100)

- **PLAYER_POS**  
  ゲーム内におけるプレイヤーの座標 (PLAYER_X, PLAYER_Y)（ゲーム内座標系）。

---

## 座標系と変換

描画の効率化のため、以下の2つの座標空間を用います。

1. **ゲーム内座標系**  
   ゲームの論理的な位置を表す座標系  
   例: (x, y) ∈ ℤ²

2. **タイル座標系**  
   タイル単位の座標。  
   ゲーム内座標とタイルの大きさを用いて変換します。  
   {X, Y} = (x, y) * TILE_SIZE

スクリーン（描画）座標は、タイル座標からさらに画面上の表示位置へオフセット変換します。

---

## スクリーン描画位置の算出

画面上に描画する際は、マップ全体から現在の表示領域（カメラ）の左上角 **TOPLEFT** を引いた位置に各要素を配置します。  
関数 f により、スクリーン上の描画位置 {X', Y'} は次のように求められます。

```
{X', Y'} = {X, Y} - TOPLEFT
```


---

## TOPLEFT 座標の計算

**TOPLEFT** は、プレイヤーを画面中央に表示するためのオフセットですが、マップの端に到達した場合はクラッピング（切り詰め）される必要があります。  
一般的な計算式は以下の通りです。

```
TOPLEFT = max(0, min( PLAYER_POS * TILE_SIZE - SCREEN_SIZE / 2, MAP_SIZE * TILE_SIZE - SCREEN_SIZE ))
```


- **PLAYER_POS * TILE_SIZE - SCREEN_SIZE / 2**  
  プレイヤーを常にスクリーン中央に配置するための理想的なオフセット。

- **MAP_SIZE * TILE_SIZE - SCREEN_SIZE**  
  マップの右端または下端に達した場合の最大オフセット。

- **max(0, …)**  
  オフセットが負にならないよう下限 0 を設定。

これにより、プレイヤーがマップの中央にいる場合は画面中央表示、端に近い場合はマップ範囲内に収めた描画となります。

---

## まとめ

1. ゲーム内座標系で各エンティティの位置を管理します。  
2. ゲーム内座標を基にタイル座標系に変換し、さらに画面描画時は **TOPLEFT** を減算してスクリーン座標を求めます。  
3. **TOPLEFT** は、プレイヤーを中心に画面を動かしつつ、マップ外に描画領域が広がらないよう制限されます。

以上の流れにより、マップやエンティティの描画が一貫した座標変換で正しく行われるようになります。